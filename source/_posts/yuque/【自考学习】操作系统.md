---
title: 【自考学习】操作系统
urlname: xekyga
date: '2020-01-31 21:15:46 -0800'
tags: [操作系统]
categories: [计算机]
---

# 一、操作系统概论

## 计算机系统的资源：

```
硬件资源
软件资源
在计算机系统中，集中为了资源管理功能和控制程序执行功能的一种软件，称为操作系统。
```

## 操作系统的定义:

```
定义的解析：

组织和管理计算机系统中的硬件资源和软件资源。

有效：指操作系统在管理计算机资源时要考虑到系统运行的效率和利源的利用率。要尽可能提高中央处理器的利用率，让它尽可能少的空转，应该在保证访问效能的前提下尽可能有效地利用其它资源。
	比如，减少内存、硬盘资源的浪费

合理： 指操作系统要公平对待不同的用户程序，保证系统不发生死锁和饥饿的现象。

方便：指操作系统的人机界面要考虑到用户使用界面和程序接口两个方面的易用性、易学性和易维护性
	用户接口：命令、图形界面
  程序接口： windows api， linux 系统调用。（程序员更方便使用程序接口进行编程）
```

## 操作系统的特征：

```
并发性
	是指计算机系统中同时存在着若干个运行着的程序，从宏观上看，这些程序在同时向前推进。
共享性
	操作系统需与多个用户程序共用系统中的各种资源，（CPU、内存、外部设备等）
随机性（异步性）
	操作系统不能对所运行的程序的行为以及硬件设备的情况作出任何事先的假定

```

## 操作系统的观点

```
软件的观点：
	操作系统是一个大型系统软件，它是多种功能程序的集合。有外在特性和内在特性。
  	外在：接口
    内在：与硬件交互

资源管理的观点
 	操作系统负责登记谁在使用什么样的资源，系统中还有哪些资源空闲，当前响应了谁对资源的请求，以及回收那些不再使用的资源等。

进程的观点
 	把操作系统看做由多个可以同时独立运行的程序和一个对这些程序进行协调的核心。
 	侧重于分析系统各部分的并行工作，研究处理各项管理任务的分割以及这些管理任务相互之间的关系。
  比如，竞争资源、进程通信等

虚拟机的观点
	在操作系统的支持下，用户不需要直接使用硬件机器，而是通过操作系统提供的各种手段来控制和使用计算机。

服务提供者的观点
	从用户的角度，站在操作系统之外观察操作系统，认为该服务提供者为用户提供了比裸机功能更强、服务质量更高、更方便灵活的虚拟机。
```

## 操作系统的功能

```
进程管理
	进程管理的实质：对中央处理器进行管理，或者称为处理器管理。
  多道程序技术：多个程序同时放入内存，如果一个程序因为等待某个条件而不能运行，就把处理器专用权转交给另一个可运行程序。
	进行的引入：为了描述多道程序的并发而引入（PCB）
  进程的简单定义: 一个程序的运行过程
  进程管理的内容：进程控制、进程同步、进程间通信、调度。

存储管理
	任务：管理计算机内存的资源
  功能：
  	内存的分配与回收：当多个程序共享有限的内存资源时，要考虑如何为多个程序分配有限的内存空间，以及程序运行完毕还需要内存回收。
    存储保护：存储在内存中的多个程序和数据应该彼此隔离、互不侵扰
    内存扩充：将辅助存储器作为内存的扩充空间

文件管理
	任务：有效地支持文件的存储、检索和修改等操作，解决文件的共享、保密和保护问题，以便用户方便、安全地访问文件
  功能：
  	文件存储空间的管理
    目录管理
    文件系统的安全性

设备管理
	设备管理的含义
  	指计算机系统中除了处理器和内存以外的所有输入、输出设备的管理
  功能
   	负责外部设备的分配、启动和故障处理
  采用的技术
  	中断技术、通道技术、虚拟设备技术、缓冲技术、尽可能发挥设备和主机的并行能力

用户接口
	从用户观点看，操作系统是用户与计算机之间的接口
	任务：为用户提供一个使用系统的良好环境，使用户能有效地组织自己的工作流程，并使整个系统高效地运行。
```

## 操作系统的体系结构

### Windows 操作系统的体系结构

```
内核
	功能：线程调度、陷入处理和异常调度、中断处理和调度、多处理器同步、供执行体使用的基本内核对象。
硬件抽象层HAL
	系统可移植性的关键部分，为运行在windows操作系统上的硬件平台低级接口，隐藏了各种与硬件有关的细节，如I/O接口等专用的和依赖于计算机平台的函数
执行体
	属于内核，以系统函数的形式提供了系统的服务，可通过win32API进行访问
系统进程和系统线程
	执行系统代码
```

### Unix 操作系统的体系结构

```
内核层
	是操作系统管理和控制中心，常驻内存。
  有两种接口：内核与硬件和接口和内核与shell的接口

系统层
	内核层与应用层之间，供程序员开发调用，包括进程管理、文件管理、中断状态

应用层
	面向用户操作的界面
```

### Linux 操作系统的体系结构

```
内核、shell、文件、系统和应用程序
```

### Android 操作系统的体系结构

```
应用程序从，应用框架层，系统运行层，Linux内核层
```

## 操作系统的发展

```
手工阶段
监控程序
多道批处理
分时与实时操作系统
Unix通用操作系统
个人计算机操作系统
Android操作系统
```

## 操作系统的分类

### 批处理操作系统

```
基本工作方式
	用户将作业交给系统操作员，系统操作员在收到作业后，并不立即将作业输入计算机，
  而是收到一定数量的用户作业之后，组成一批作业，再把这批作业输入到计算机中。
  这批作业可在操作系统中形成一个连续的、自动转接的作业流。
  系统操作员然后启动操作系统，系统自动、依次执行每个作业。
  最后由操作员将执行完毕的作业交给用户。

特点与分类
	特点:成批处理，用户不能干预自己作业的运行
  目标：系统资源利用率高，作业吞吐率高。
  分类：简单批处理和多道批处理。

设计思想：
	在监控程序启动之前，操作员有选择地把若干个作业合并成一批作业，将这批作业安装在输入设备上。
  然后启动监控程序，监控程序将自动控制这批作业的执行。
  作业的运行与衔接都由监控程序自动控制，从而有效地提高了作业运行的效率。

作业控制说明书
	作业控制说明书是由作业控制语言编写的一段程序，它通常存储在被处理作业的前面
  作业的运行由作业控制说明书来传递给监控程序，运行过程中，监控程序读入并解释作业说明书，
  以控制各个作业步的执行。

一般指令和特权指令
	操作系统的运行模式：用户模式和特权模式
  处理器的状态：目态和管态
  机器指令：一般指令和特权指令
  系统调用：用户程序不能直接使用特权指令，它们必须向操作系统请求这些功能，这些功能通过系统调用完成。

系统调用的过程
	首先，当系统调用发生时，由中断或异常处理程序，把控制流程转移到监控程序内的一些特定位置处理器模式变成特权模式
  其次，由监控程序执行被请求的功能
  最后，恢复现场，运行模式转变为用户模式，控制权交给用户程序

SPOOLing技术
	是多道程序设计的关键技术之一，也称为假脱机技术
```

### 分时系统

```
基本工作方式
	在分时系统中，一台主机连接了若干个终端，每个终端可由一个用户使用。用户通过终端交互式地向系统提出命令请求，
  系统接收到用户命令之后，采用时间片轮转方式处理服务请求，并通过交互方式在终端上向用户显示结果。

特点
	多路线
  交互性
  “独占性”
  及时性


```

### 实时系统

```
实时操作系统是指，
	使计算机能在规定时间内，及时响应外部事件的请求，同时完成对该事件的处理，并能够控制所有实时设备和实时任务协调一致地工作的操作系统

目标
	在严格时间范围内，对外部请求做出反应，系统具有高可靠性。

分类：
	硬实时系统和软实时系统

能力
	除了多道程序系统的基本能力外，还有以下功能：
  	实时时钟管理
    过载防护
    高可靠性
```

### 个人操作系统

```
单用户操作系统一次只能支持一个用户程序的运行。单用户操作系统向用户提供联机交互式的工作环境，比如MS-DOS就是一个经典的单用户操作系统。
```

### 网络操作系统

```
一种在通常操作系统功能的基础上提供网络通信和网络服务功能的操作系统。

```

### 分布式操作系统

```
一种以计算机网络为基础的，将物理上分布的具有自治功能的数据处理系统或计算机系统互联起来的操作系统。分布式系统中各台计算机无主次之分，系统中若干台计算机可以并行运行同一个程序，分布式操作系统用于管理分布式系统资源。
```

### 嵌入式操作系统

```
定义
	在各种电器、电子和智能机械上，嵌入安装着各种微处理器或微控制芯片
  嵌入式操作系统就是运行在嵌入式芯片环境中，对整个芯片以及它所操作、控制的各种部件装置等资源进行统一协调、调度、指挥和控制的系统软件。

微型化、实时性、高可靠性
```

## 操作系统设计

### 操作系统的设计过程

```
功能设计
	确定所设计的操作系统应具备哪些功能以及操作系统的类型，跟目标有关

算法设计
	选择和设计满足系统功能的算法和策略，并分析和估算其效能。

结构设计
```

### 操作系统的设计目标

```
可靠性
高效性
易维护性
可移植性
安全性
简明性
```

### 操作系统的结构设计

```
操作系统结构研究的目标
	系统模块化
	模块标准化
	通信规范化

常见的操作系统的结构
	整体式结构
  层次式结构
  微内核（客户/服务器）结构

```

# 二、操作系统运行环境

## 1、处理器

### ①、处理器的构成与基本工作方式

```
处理器一般由运算器、控制器和一系列寄存器以及高速缓存构成
运算器实现算数与逻辑运算
控制器控制程序运行流程
寄存器用于处理器执行指令的过程中暂存数据、地址及指令信息
高速缓存：为CPU和内存提供一个高速的数据缓存区域

```

#### 处理器中的寄存器

```
两类寄存器
 	用户可见寄存器，由编译程序分配，减少程序运行时访问内存的次数
   （一般包括数据寄存器，地址寄存器，条件码寄存器）
```

#### 指令执行的基本过程

```
最简单的是两个步骤
	读取指令，并将程序计数器的值变成下一条指令的地址
  指令放入指令寄存器中，处理器解释并执行该指令。

指令分类
	访问存储指令、I/O指令、算数逻辑指令、控制转移指令、控制器控制指令
```

### ②、特权指令和非特权指令

> 在多道程序环境下，指令分为特权指令和非特权指令

#### 特权指令

```
在操作系统中哪些只能由操作系统使用的指令
不允许一般用户使用
比如：设置程序状态字、启动某设备、设置中断屏蔽字等
```

非特权指令

```
普通用户使用的指令
```

### ③、处理器的工作状态

#### 管态和目态

> 管态：操作系统管理程序运行时的状态，又称内核态、系统态等，具由较高特权
> 目态：一般用户程序运行时的状态，又称用户态、普通态、具有较低特权

#### 处理器工作状态的转换

```
目态到管态的转换：
	唯一途径是通过中断。中断响应式交换中断向量，新的中断向量的PSW（程序状态寄存器）的处理器状态标志位管态

管态到目态的转换：
	可通过设置PSW指令、实现从操作系统到用户程序的转换
```

#### 限制用户程序执行特权指令

> 当用户程序执行时，如果取到了一条特权指令，则处理器拒绝执行该指令，并形成一个“非法操作”事件，然后操作系统通知用户程序-程序中有非法指令

#### 程序状态字

> 为了解决处理器当前工作状态的问题，所有的处理器都由一些特殊寄存器，用以表明处理器当前的工作状态。用来指示处理器状态的寄存器，称为程序状态字。
> 比如 CF：进位标志，ZF：结果为零标志等

| 31  | ....... | 2   | 1   | 0   |
| --- | ------- | --- | --- | --- |
| ZF  | AF      | PF  | 1   | CF  |

```
程序状态字一般包括：
	CPU的工作状态代码：指名当前的工作状态是管态还是目态
  条件码：反映指令执行后的结果特征，比如结果为0等
  中断屏蔽码：指出是否允许中断
```

## 2、硬件部件

### ①、存储系统

#### 存储器的类型

```
类型
	读写型存储器（RAM），用来存储随机存取的程序和数据
	只读存储器（ROM），存放一些固化的程序

存储分块
	存储的最小单位：位(bit)
  最小编制单位：字节
  分块：为了分配和管理方便，将内存划分为大相等的块（物理页Page），以块为单位分配内存空间，大小一般为512B,1KB,4KB,8KB等

```

#### 存储器的层次结构

> 容量、速度和成本匹配

![u=1432493203,1397722736&fm=26&gp=0.jpg](https://cdn.nlark.com/yuque/0/2020/jpeg/290620/1580545508494-28dec47e-75a0-4810-aeca-3fd67d91543e.jpeg#align=left&display=inline&height=445&margin=%5Bobject%20Object%5D&name=u%3D1432493203%2C1397722736%26fm%3D26%26gp%3D0.jpg&originHeight=445&originWidth=706&size=146044&status=done&style=none&width=706)

> 存储访问局部性原理

```
程序执行时，除了少部分的转移和过程调用指令外，在大多数情况下是顺序执行的

过程调用将会使程序的执行轨迹，由一部分区域转至另一部分区域。即程序将会在一段时间内，都局部在这些过程的范围内运行

程序中存在许多循环结构，这些虽然只由少数指令构成，但是它们将多次执行。

程序中还包括许多对数据结构的处理，如对数组进行操作，它们往往都局限于很小的范围内。

基于这一原理，设计多级存储的体系结构
```

#### 存储器保护

> 多道程序设计系统中，保证每个程序独立运行、互不干扰、称为存储器保护
> 方法：界地址寄存器

### ②、I/O 部件

#### I/O 结构

#### 通道

#### DMA 技术

#### 缓冲技术

### ③、时钟部件

#### 功能

```
发现死循环，防止机时的浪费
分时系统中，时钟间隔实现事件片轮转执行
实时系统中，按要求的时间间隔控制设备
定时唤醒各种外部事件
记录各种设备的使用时间和某外部事件发生的时间间隔
记录用户和系统所需的绝对时间，即年、月、日
```

#### 分类

```
硬件时钟和软件时钟
用途分：绝对时钟和相对时钟
```

## 3、中断机制

### ①、中断与异常

#### 中断：

> 指处理器对系统中或系统外发生的异步事件的响应

#### 异步事件：

> 指无一定时序关系的随机发生的事件，如外部设备完成了数据传输任务，某以实时控制设备出现异常情况等

#### 中断源：

> 引起中断的事件称为中断事件或中断源

#### 中断请求：

> 中断源向处理器发出的请求信号

#### 中断处理程序：

> 处理中断事件的程序

#### 断点：

> 发生中断时正在执行的程序的暂停点

#### 中断响应：

> 处理器暂停当前程序转而处理中断的过程

#### 中断返回：

> 中断处理程序结束之后恢复原来程序的执行

#### 中断向量表：

> 为了使得中断装置可以找到恰当的中断处理程序，专门设计了中断处理程序的入口地址映射表，又称中断向量表

#### 异常：

> 由正在执行的指令引发的中断

#### 典型的中断：

> 时钟中断、输入输出中断、控制台中断、硬件故障中断

#### 典型的异常：

> 程序性中断、访管指令异常

### ②、中断请求的接收

> 中断系统如何接受中断源的中断请求，因机器而异。一般由中断逻辑线路和中断寄存器实现

### ③、中断响应

> 处理器的控制部件中以后中断信号扫码结构，它在每条指令执行周期内的最后时刻扫码中断寄存器，查看是否由中断信号到来。若无中断信号，处理器就继续执行下一条指令。若由中断到来，处理器接收由硬件中断装置发来的中断向量代号，准备中断处理工作。

#### 中断请求响应过程

```
处理器接收中断信号
保护现场
分析中断向量
将处理器的PC值置为中断程序的入口地址
调用中断处理程序

```

### ④、中断处理

> 中断信号被接收和响应之后，进行中断处理，包括：检查 I/O 相关的状态信息，操纵 I/O 设备或者在设备和内存之间传送数据等。
> 中断处理结束后，中断返回，恢复系统上下文，原有程序继续运行。处理器状态也从管态恢复成目态。

```
整个中断信号的接收、响应和处理过程，可归纳为以下步骤：
	接收和响应中断
  保护中断断点现场
  分析中断向量，调用中断处理程序
  中断处理结束恢复现场，原有程序继续执行
```

### ⑤、几种典型中断的处理

自愿性：
I/O 中断
时钟中断
硬件故障中断
程序性中断
强迫性：
系统服务请求

## 4、中断优先级、中断屏蔽与中断嵌套

### ①、多级中断与中断优先级

#### 作用：

> 对各类中断信号依据其紧急程序和重要性划分级别，系统优先处理最紧急或最重要的任务
> 解决如果由多个中断信号同时到达，如何选择首个被处理的中断信号的问题

### ②、中断屏蔽

> 整个中断系统中， 允许或者禁止中断系统对某些类别中断的响应。PSW 中设计有中断屏蔽位
> 比如：某个 I/O 被中断屏蔽，意味着即使有 I/O 中断信号，处理器也不响应
> 注意：有些信号是不能被屏蔽的。一般这些中断信号属于机器故障中断，比如断电，机器无法继续操作。一旦发生，无论信号是否被屏蔽，处理器都会立即响应，并进行处理。

### ③、中断嵌套

> 一般的计算机系统都有多个中断源，如果一个中断处理的过程中又发生了中断，有两种策略处理：
> 1、当处理一个中断时禁止其他中断
> 2、中断嵌套。即中断按照优先级划分，允许优先级高的中断优先级低的中断处理过程，优先进行处理。

## 5、系统调用

> 就是用户在程序中调用操作系统提供的一些子功能，是操作系统提供给编程人员的唯一接口
> 是一个中特殊的过程调用，由特殊的机器指令实现，这条指令将使系统转入管态

### ①、系统调用与函数调用的区别

> 运行在不同的状态
> 状态的转换
> 返回问题
> 嵌套调用

### ②、系统调用的分类

> 进程控制类
> 文件操作类
> 进程通信类
> 设备管理类
> 信息维护类

### ③、系统调用与库函数、API、内核函数的关系

## 6、系统调用的处理过程

#### 陷入：

> 在系统中为控制系统调用服务的机构称为陷入或异常处理机构

#### 陷入或异常指令（访管指令）

> 把由于系统调用引起处理器中断的指令称为陷入或异常指令（访管指令）

# 三、进程管理

## 1、多道程序设计

### ①、顺序程序设计

> 程序是在一个时间上按照严格次序前后相继的操作序列
> 计算机也是以顺序方式工作的：计算机一次执行一条指令、对内存一次访问一个字节或字，对外部设备一次传送一个数据块等
> 我们把一个具有独立功能的程序独占处理器直到得到最终结果的过程称为程序的顺序执行

### ②、程序的顺序执行的特点

#### 顺序性

程序所规定的动作在机器上严格地按照顺序执行

#### 封闭性

程序运行后，其计算结果指取决于程序自身，程序执行得到的最终结果由给定的初始条件决定，不受外界因素影响。

#### 程序执行结果的确定性

程序的执行的结果与其执行速度无关

#### 程序执行结果的可在现性

如果程序在不同的时间执行，只要初始体哦阿健相同，则结果就会相同。

### ③、程序的并发性执行

> 所谓并发执行，是指两个或两个以上程序在计算机系统中，同时处于已开始执行且尚未结束的状态
> 能够参与并发执行的程序称为并发程序
> 并发程序的执行和程序顺序执行的特征不同

### ④、并发执行的特征

> 在执行期间并发程序相互制约
> 程序与计算不再一一对应：
> 允许多个程序共享一个程序段
> 并发程序的执行结果不可再现：
> 并发程序与其执行的相对速度以及并发执行的多道程序之间的相互关系有关。
> 程序的并行执行和程序的并发执行
> 程序的并发执行是宏观上的同时，微观是顺序。并行则是微观上是同时的。

### ⑤、多道程序设计：

就是允许多个程序同时进入内存并运行。根本日暮是提高整个系统的效率。

### ⑥、吞吐量：

是指单位时间内系统所处理进程的道数，是衡量系统效率的尺度。

### ⑦、特点：

独立性：在多道环境下执行的没到程序都是逻辑上独立的，且执行速度与其他程序无关，执行的起止时间也是独立的
随机性：程序和数据的输入与执行开始时间都是随机的
资源共享性：

### ⑧、缺陷：

可能延长程序的执行时间
系统效率的提高由一定限度

## 2、进程

> 进程是具有一定独立功能的程序在某个数据集合上的一次运行活动，是系统进行资源分配和调度的一个独立单位。
> 分为：系统进程和用户进程

### ①、进程与程序的联系和区别

#### 联系：

程序是构成进程的组成部分之一，一个进程是运行目标是执行它所对应的程序。
进程=程序+数据+进程控制块

#### 区别：

程序是静态的，进程是动态的
二者是对多对的关系

### ②、可再入程序

一个能够被多个用户同时调用的程序称作是“可再入”程序
可再入程序必须是纯代码，程序在执行过程中不会修改自己的代码，必须与数据区隔离。
比如：操作系统、编译程序，它们能同时被不同用户调用而形成不同的进程。

### ③、进程的特征

并发性
动态性
独立性
交往性
异步性
结构性

### ④、进程模型

#### 三状态进程模型

运行状态
就绪状态
等待状态

#### 状态转换

就绪=》运行
运行=》就绪
运行=》等待
等待=》就绪

#### 五状态进程模型

运行状态
就绪状态
阻塞状态
创建状态
结束状态

#### 七状态进程模型

### ⑤、进程控制块

为了便于系统操控和描述进程的活动过程，在操作系统核心中定义了一个专门的数据结构，称为 PCB

#### PCB 的作用：

描述进程的基本情况以及进程的运行变化过程。
PCB 是进程存在的唯一标志，当系统创建一个进程时，为进程设置一个 PCB，再利用 PCB 对进程进行控制和管理。撤销进程时，系统收回 PCB，进程也随之消亡。

#### PCB 的内容：调度信息

供进程调度时使用，包括进程名、进程号、地址空间信息、优先级、当前状态、资源清单、“家族”关系、消息队列指针、进程队列指针和当前打开文件等。

#### PCB 的内容：现场信息

刻画了进程的运行情况，主要是 CPU 寄存器的信息，如程序状态字、时钟、界地址寄存器等。当程序中断时，需要保存现场信息。

#### 进程的组成

进程由程序、数据和进程控制块组成
PCB 是"灵魂"
程序和数据是"躯体"

#### PCB 组织

线性方式
索引方式
链接方式

#### 进程的队列

就绪队列（一个或多个）
等待队列（多个）
运行队列

#### 进程队列的组成

进程队列实际是 PCB 的链接。链接分为：单向链表和双向链表
出队：一个进程从所在队列退出
入队：一个进程排入到指定队列
插队：一个进程插入到某个进程队列的指定位置

## 3、进程控制

> 对进程整个生命周期中各种状态之间的转换进行的控制。由原语实现。
> 原语：
> 就是由若干条指令组成，用于完成一定功能的一个过程，是一个不可分割的基本单位，即原语在执行过程中不想允许被中断。原子操作在系统态下执行，常驻内存

### ⑥、进程的控制原语

#### 创建原语

> 一个进程可以使用创建

#### 撤销原语

#### 阻塞原语

#### 唤醒原语

## 4、经典的进程同步问题

### ①、简单生产者--消费者问题

> 设有一个生产者进程 P，一个消费者进程 Q，他们通过一个缓冲区联系起来

![](https://cdn.nlark.com/yuque/0/2020/svg/290620/1581303206825-2ad169b4-7715-4595-bb33-a854c664b802.svg)

#### 二者关系描述：

生产者生产产品放入缓冲区，消费者从缓冲区取产品，进行消费
P 进程不能往已经"满"的缓冲区放产品，Q 进程不从"空"缓冲区中取产品

#### 信号量设置：

empty: 初始设为 1，用于指示空缓冲区数量
full: 初始值为 0，用于指示满缓冲区数量

#### 解决方案:

```
进程P：

while(true) {
	P(empty):
  生产一个产品;
  送产品到缓冲区;
  V(full)
}

进程Q:
whie(true) {
	P(full);
  从缓冲区取产品;
  V(empty);
  消费产品;
}
```

### ②、多个生产者-消费者问题

> 设有若干个生产者 P1、P2、...若干个消费者 Q1、Q2...他们通过一个环形缓冲池联系起来

![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581309753452-61213a34-0606-4843-a921-8ae99a2fb216.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=image.png&originHeight=264&originWidth=350&size=9403&status=done&style=none&width=350)

#### 同步问题和信号量设置

生产者不能往满缓冲区中放产品，设置信号链 empty，初始值为 K，指示缓冲池中空缓冲区数目
消费者不能从空缓冲区中取产品，设置信号量 full，初始值为 0，指示缓冲池中的满缓冲区数目

#### 互斥问题和信号量设置：

缓冲池必须互斥访问，设置信号链 mutex，初值为 1。

#### 其他变量设置

整型量 i，j，初始值为 0，分别用于指示空缓冲区和满缓冲区的位置

#### 算法

```
进程P1,P2...
i=0;
while(true) {
	生产产品;
  P(empty);
  P(mutex);
  往buffer[i]中放产品;
  i=(i+1) mod k;
  V(mutex);
  V(full);
}

进程Q1、Q2...
j=0;
while(true) {
	P(full);
  P(mutex);
  从buffer[j]取产品
  j=(j+1) mod k;
  V(mutex);
  V(empty)；
  消费产品;
}
```

## 5、管程的提出

### ①、信号量及 PV 操作的缺点

程序易读性差
程序不利于修改和维护
正确性难以保证
为了更易于编写正确的程序，引入了管程

#### 定义:

是一个由过程，变量及数据结果等组成的一个集合，它们组成一个特殊的模块或软件包。进程可在任何需要的时候调用管程中的过程。

#### 组成：

管程名称、共享数据说明、对数据进行操作的一组过程、对共享数据赋初值的语句

### ②、进程通信

#### 共享内存

在相互通信的进程之间，设又一个公共内存区，一组进程向该公共内存中写，另一组进程从公共内存中读，通过这种方式实现两组进程之间的信息交换。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581314886199-248b4942-e238-400a-a65e-5eb64ff02661.png#align=left&display=inline&height=472&margin=%5Bobject%20Object%5D&name=image.png&originHeight=472&originWidth=282&size=12624&status=done&style=none&width=282)

### ③、消息机制-消息缓冲

#### 消息缓冲通信原理：

进程间的数据交换，是以格式化的消息（也称为报文）为单位的。程序员直接利用操作系统提供的一组通信命令（原语），实现大量数据的传递，通信过程对用户是透明的。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581315493259-3c315596-8fd6-42f1-94e5-52e33b863486.png#align=left&display=inline&height=610&margin=%5Bobject%20Object%5D&name=image.png&originHeight=610&originWidth=1125&size=38458&status=done&style=none&width=1125)

#### 信箱通信原理：

为了实现进程间的通信，可以设计一个通信机构--信箱，以发送信件和接收信件为进程间通信的基本方式。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581315782698-6991d45a-3785-4409-b933-4073f2440a26.png#align=left&display=inline&height=351&margin=%5Bobject%20Object%5D&name=image.png&originHeight=351&originWidth=979&size=21050&status=done&style=none&width=979)

#### 管道通信

所谓"管道"，是指用于连接一个读进程和一个写进程以实现他们之间通信的一个共享文件，又名 pipe 文件
最早出现在 UNIX 系统中，是 UNIX 系统进程通信的一大特色
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581316071561-aaff60cb-d3b3-460f-88a7-b570b511d8f6.png#align=left&display=inline&height=113&margin=%5Bobject%20Object%5D&name=image.png&originHeight=113&originWidth=625&size=5066&status=done&style=none&width=625)

## 6、死锁

### ①、死锁产生

在多道程序系统中，同时又多个进程并发执行，共享系统资源，从而提高了系统资源利用率，提高了系统的处理能力。
但是，在进行资源分配时会产生一个随机性的错误--死锁。
在许多应用中，如实时控制和监视系统中，如果遇到死锁会带来很大的危害。

#### 定义

指在多道程序系统中，一组进程中的每一个进程郡无限期地等待被该组进程中的另一个进程所占用且永远不会释放的资源。
处于死锁状态的进程称为死锁进程。

#### 资源的概念：

永久性资源（可重用资源）：
如内存、外部设备、处理器等硬件资源。
各种数据文件、表格、共享程序代码等
临时性资源（消耗性资源）：
指由某个进程产生、只为另一个进程使用一次或经过短暂时间后便不再使用的资源。
如果 I/O 和时钟中断信号、同步信号、消息等。

#### 产生死锁的原因

竞争资源
系统在资源分配时出现失误、进程间对资源的相互争夺而造成僵局
进程推进顺序不合理

#### 产生死锁的必要条件

对于永久性资源，产生死锁的四个必要条件
互斥条件
不可剥夺条件
请求和保持条件
循环等待条件

#### 解决死锁的方法

预防死锁
避免死锁
检测与解除死锁
忽略死锁

### ②、死锁预防

> 是指在任何系统操作前（如分配资源、调度进程等），事先评估系统的可能情况，严格采取措施，使得产生死锁的四个必要条件不成立

#### 基本思想

防患于未然

#### 具体做法

破坏产生死锁的四个必要条件之一

#### 静态的资源分配策略

分配原则:
一个进程在申请新资源的要求得不到满足时，便处于等待状态，而处于等待状态的进程的全部资源可以被剥夺。
两个策略:
破坏不可剥夺条件
破坏请求和保持条件

#### 破坏不可剥夺条件：

```
两种方法：
	若一个进程已经占用了某些资源，又要申请新的资源，在得不到新资源的同时释放原有资源，然后等待。
  若一个进程申请新资源，首先系统检测该资源是否可用，如果可用则分配。否则从其他等待进程剥夺资源分配给该进程，如果没有等待进程占有该资源，该进程必须等待，在等待过程中，资源也可能被剥夺。
```

#### 破坏请求和保持条件：

```
方法：
	每个进程必须在开始执行前就申请它所需要的全部资源，仅当前系统能满足进程的资源请求且把资源一次性分配给进程后，该进程才能开始执行。
```

#### 资源的有序分配方法

策略：
破坏循环等待条件
方法：
对系统所有资源类型进行线性排序，

### ③、死锁避免

#### 基本思想：

系统对进程发出的每一个系统能够满足的资源申请进行动态检查，并根据检查结果决定是否分配资源；如果分配后系统不会发送死锁，则予与分配，否则，不予分配。

#### 和死锁预防的区别：

死锁预防是破坏产生死锁的四个必要条件之一，严格地防止死锁的出现。而死锁避免是在系统运行过程中注意避免死锁的发送，即使死锁的必要条件存在，也不一定发送死锁。

#### 安全状态与安全序列：

如果操作系统能保证所有的进程在有限时间内得到所需的全部资源，则称系统 处于“安全状态”，否则说系统是不安全的。
判断：如果存在一个由系统中所有及昵称构成的安全序列(P1,P2,...Pn)，则系统处于安全状态。

#### 安全状态与不安全状态的关系：

系统中不存在安全序列，则称系统为不安全

#### 安全状态与不安全状态的关系：

![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581409081880-1403d646-f7da-4a87-b911-9b7c6d3a90ec.png#align=left&display=inline&height=150&margin=%5Bobject%20Object%5D&name=image.png&originHeight=150&originWidth=440&size=6759&status=done&style=none&width=440)

#### 银行家算法：

原意:
确保银行在发放现金贷款时，不会发生不能满足所有客户需求的情况
操作系统:
保证系统不会进入不安全状态的算法

### ④、死锁的检测与解除

假如系统为进程分配资源时，不采取任何限制性措施来避免和预防死锁，而是在操作系统运行过程中，不断地监督程序的执行和资源占用情况，判断是否为死锁，一旦发生死锁，采取专门的措施解除死锁，并以最小代价使系统恢复正常。

#### 死锁检测时机

检测的实质：
检测算法检测是否存在“循环等待”条件。
时机：
一次资源分配后
每次调度后
定时器定时运行检测程序
当某个进程长期处于阻塞状态或阻塞程序过多时

#### 解除死锁的方法

剥夺资源
一旦死锁，挂起一些进程，剥夺它们占有的资源给死锁进程，以解除死锁
撤销进程
撤销部分死锁进程，将它们占有的资源分配给另一个死锁进程，直到死锁解除为止。
可以一次撤销所有死锁进程，也可以逐个撤销

## 7、资源分配图

### ①、资源分配图

#### 作用：

描述系统中资源分配和申请情况，对死锁进程分析并采取对策

#### SRAG 定义

是一张有向图，可定义为一个二元组，即，SRAG=(V,E)，其中 V 是顶点的集合，包括进程集合、资源集合，E 是向边的集合，是一个有序对（Pi, ri）

, ![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581410738271-91417ae5-344c-42be-9bfe-49211e1a1a68.png#align=left&display=inline&height=258&margin=%5Bobject%20Object%5D&name=image.png&originHeight=258&originWidth=472&size=13959&status=done&style=none&width=472)

### ②、死锁定理

#### 作用：

判定死锁的法则

#### 死锁定理

如果资源分配图中没有环路，则系统无死锁。
如果资源分配图中出现了环路，则可能存在死锁。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581411040528-152a90bb-dc2a-46ca-841b-28ec0d9cc0ff.png#align=left&display=inline&height=361&margin=%5Bobject%20Object%5D&name=image.png&originHeight=361&originWidth=373&size=12762&status=done&style=none&width=373)

### ③、资源分配图简化方法

步骤：
在资源分配图中，找出一个既不阻塞又非独立的进程结点 Pi。在顺利的情况下，Pi 可获得所需资源而继续运行，直至运行完毕，再释放其所占有的全部资源，这相当于消去 Pi 的请求边和分配边，使之成为孤立的结点。
将 Pi 释放的资源分配给申请它的进程，若该进程能顺利运行完成，释放资源，再次成为孤立结点。
重复以上步，直至找不到符合条件的进程结点。
经过化简后，若能消去所有的边，则该图可完全简化，系统不存在死锁；否则不可完全简化，存在死锁。

### ④、哲学家就餐问题

假设有 5 个哲学家，他们的生活只是思考和吃饭。这些哲学家共用一个圆桌，每位都有一把椅子。在桌子中央有一碗米饭，在桌子上放着 5 根筷子
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581421043610-dbedb0eb-93de-4f49-b1e9-f5ba328452ef.png#align=left&display=inline&height=346&margin=%5Bobject%20Object%5D&name=image.png&originHeight=346&originWidth=408&size=35488&status=done&style=none&width=408)

#### 算法分析

```
semaphore chopstick[5] = {1,1,1,1,1}

do {
    P(chopstick[i]);	// 拿左筷子
    P(chopstick[(i+1) % 5]); // 拿右筷子
    ...
    eat;
    ...
    V(chopstick[i]); // 放左筷子
    V(chopstick[(i+1) % 5]); // 放右筷子
    ...
    think;
} while (true);
```

#### 存在问题

死锁

#### 改进

采用资源有序分配算法，给每个筷子编号，规定每个哲学家先拿编号小的筷子再拿编号大的筷子，哲学家 I（1<=i<=4）不变，第五个哲学家的程序改进如下：

```
semaphore chopstick[5] = {1,1,1,1,1}

do {
    P(chopstick[1]);	// 拿右筷子
    P(chopstick[5]); // 拿左筷子
    ...
    eat;
    ...
    V(chopstick[1]); // 放右筷子
    V(chopstick[5]); // 放左筷子
    ...
    think;
} while (true);
```

# 四、存储管理

## 1、存储管理的任务

### ①、内存管理

#### 内存空间一般分为两个区域:

系统区：存放操作系统常驻内存部分，用户不能占用这部分空间
用户区：分配给用户使用，用于装入和存储用户程序和数据，随时变化。

#### 存储管理的实质：

用户空间的管理

#### 内存管理问题主要包括

内存管理方法
内存的分配与释放算法
虚拟存储器的管理
控制内存和外村之间的数据流动方法
地址变化技术
内存数据保护与共享技术

### ②、内存的分配和回收

#### 功能

记住每个存储区域的状态：空间与否
实施分配：用户提出请求，分配内存
回收：回收用户释放的区域

#### 内存分配表

位示图表示法
空闲页面法
空闲块表法

#### 内存分配方式

静态分配：程序运行前分配内存，不允许“搬家”
动态分配：程序运行时允许动态分配内存，且允许“搬家”

#### 存储共享

所谓存储共享是指两个或多个进程公用内存中相同区域
包括：代码共享和数据共享
目的：节省内存空间，提高内存利用率‘通过内存共享实现进程通信

#### 存储保护：

目的：为多个程序共享内存提高保障，使在内存中的各道程序，只能访问它自己的区域，避免各道程序间相互干扰
方法：
地址越界保护
权限保护

#### “扩充”内存容量

用户在编制程序时，不应该受内存容量的限制，所以要次啊用一定技术来“扩充”，内存的容量，使得用户得到比实际内存容量大得多的内存空间。
借助虚拟存储技术或交换技术完成，达到在逻辑上扩充内存容量的目的。

### ③、地址转换

#### 地址重定位

> 当用户把程序装入内存时，存储管理为他分配的内存空间可能是从某一个单元开始的一组连续的地址空间，它的起始地址不固定，即逻辑地址与物理地址经常不一致
> 把逻辑地址转换为绝对地址的工作称为"地址重定位"，分为“静态重定位”和“动态重定位”两种

#### 绝对地址：

存储器以字节为单位编址，每个字节都有相应的地址，假定内存容量为 N，则编号顺序为 0，1，2，....N-1，该地址称为物理地址或绝对地址。

#### 物理地址空间

由绝对地址对应的内存空间称为“物理地址空间”。

#### 逻辑地址:

在多道程序系统中，内存中同时存储了多个用户程序，每个用户不能预先知道他的程序被存储到了什么地方。为了方便，每个用户都可认为自己的程序和数据存储在一组“0”地址开始的连续空间中，用户程序用的地址，称为“逻辑地址”或“相对地址”。

#### 逻辑地址空间

由逻辑地址对应的存储空间称为逻辑地址空间。

#### 静态重定位：

内存在装入一个程序时，把程序中的指令和数据地址全部装换为绝对地址，该过程在程序运行前进程，程序运行过程中无需再转换

#### 动态重定位：

内存在装入程序时，不进行地址转换，而是直接把程序装入到分配的内存中，程序在执行过程中完成地址转换

## 2、分区管理方案

### ①、固定分区

#### 基本思想

多道程序环境下，整个用户空间划分为若干个固定大小的分区，每个分区中只装入一道作业，分区大小可以相同，也可以不同。

#### 内存分配表与分区的分配、回收

内存分配表是一张分区说明表，记录分区号、分区大小、分区起始地址及使用状态等。
分配时按照进程的内存需求，按一定策略从分区表中找到空闲分区进行分配。
回收时，将内存分区登记在分区说明表中，并将其状态置为空闲状态。

### ②、可变分区

#### 基本思想

系统不预先划分固定分区，而是在装入程序时划分内存分区，使为程序分配的内存区的大小正好等于程序的需求量，且分区的个数是可变的

#### 紧缩技术

内存经过一段时间分配后，会存在很多很小的空间。
解决办法：紧缩

紧缩应注意的问题：
增加系统开销
移动是有条件的
比如进程正与设备交换信息，此时不能移动。
所以，采用紧缩技术时，应该尽可能减少需要移动的进程数和信息量

#### 可变分区的实现

硬件支持：
两个专用控制寄存器：基址寄存器和限长寄存器
绝对地址形成
程序装入内存后，分区的起始地址和长度装入两个寄存器，程序执行后，取出指令中的逻辑地址，绝对地址=逻辑地址+基址寄存器内存
地址越界：
当逻辑地址>限长寄存器值时，产生"地址越界"中断。
地址转换过程
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581426308841-badda089-8488-4c01-afa7-3ba94b14250e.png#align=left&display=inline&height=342&margin=%5Bobject%20Object%5D&name=image.png&originHeight=342&originWidth=835&size=17612&status=done&style=none&width=835)
内存分配表：两个表格
已分配区表
未分配区表

#### 分配策略

首次适应算法
思想：当接受到内存申请时，查找分区说明表，直到找到一个大小能满足要求的空闲分区为止，将其分割并分配。
优点：简单，可以快速做出分配决定
最优适应算法
思想：当接到内存申请时，查找分区说明表，找到一个大小能满足要求的最小空闲分区，将其分割并分配。
优点：节约空间
缺点：形成许多碎片
最坏适应算法
思想：当接到内存申请时，查找分区说明表直到找到一个大小能满足要求的最大空闲分区，将其分割并分配。
优点：碎片少
缺点：分割了大的空间，遇到较大申请，无法满足

#### 分区的回收：

当用户程序执行结束后，系统回收已使用完毕的分区，将其记录在空闲区表中。假定归还的分区起始位置为 S，长度为 L。
考虑如下四种可能性：
回收区与插入点的上领空间分区 F1 相邻接。
回收分区与插入点的下邻空间 F2 相邻接
回收区同时与插入点的上、下两个空闲分区相邻接
回收区既不与 F1 邻接，又不与 F2 邻接
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581427236867-cfa1019c-cdd8-4dce-a21c-b0f016b3bfa9.png#align=left&display=inline&height=330&margin=%5Bobject%20Object%5D&name=image.png&originHeight=330&originWidth=827&size=21569&status=done&style=none&width=827)

#### 分区的保护

两种方法：
系统设置界限寄存器，包括：上、下界寄存器或基址、限长寄存器
保护键方法

#### 分区管理方案的优缺点

优点：
简单、表格不多，实现起来容易，内存额外开销小，保护措施也简单。
在内存利用率方面可变化分区比固定分区高。
缺点：碎片多，不能为用户提供“虚存”，每个用户程序的存储受物理存储的限制。

## 3、覆盖与交换技术

### ①、覆盖技术

#### 概念

是指一个程序的若干程序段，或几个程序的某些部分共享某一个存储空间

#### 实现

把程序划分为若干功能上相对独立的程序段，按照其自身逻辑结构使那些不会同时执行的程序段共享同一块内存区域

#### 解决的问题

从用户级彻底解决内存小装不下程序的问题。

#### 优点

打破了需要将一个程序的全部信息装入内存后程序才能运行的限制
在逻辑上扩充了内存空间，从而在某种程序上实现了在小容量内存上运行较大程序的功能

#### 缺点

对用户不透明，增加了用户的负担。

### ②、交换技术

#### 交换的含义:

进程从内存移到磁盘，并再移回内存

#### 适用场合

分时系统和大多数现在操作系统，是虚拟内存系统的基础

#### 主要内容

换出进程的选择
交换时机的确定
交换空间的分配
换入进程换回内存时位置的确定

## 4、虚拟页式存储管理方案

### ①、虚拟存储技术

#### 基本思想

利用大容量外存来扩充内存，产生一个比有限的实际内存空间大的多的、逻辑的虚拟内存空间，简称虚存。
采用二级存储器方式
是一种设计技巧，受外存容量的限制

#### 虚拟存储器需要硬件支持

系统有容量足够大的外存
系统有一定容量的内存
实现虚-实转换的地址映射机制

#### 工作原理

程序部分装入内存便可运行，其他部分需要运行时再装入内存 （因为程序的局部性原理）

#### 与交换技术的区别

交换技术交换单位是进程
虚拟内存以页为单位进程交换

### ②、虚拟页式存储管理

#### 物理页面和页面

物理页面：将内存分成大小相等的许多区，每个区称为一个“物理页面”。（物理块）
页面：将程序中的逻辑地址也进行分页，页的大小和物理页面大小一直。

#### 虚拟地址组成：

虚拟页号+页内地址

### ③、物理内存的分配与回收

#### 位示图

位示图中的每一位与物理块对应，其值为 0/1，表示空闲/占用。

####   内存分配与回收

分配：在位示图中找出空闲物理页面数，如果能满足，则分配，并把相应位置为 1，计算物理页面号。
物理页面号=字号\*字长+位号
回收，当归还物理页面时，计算归还页面在位示图中对应的位置，将 1 改为 0.
字号=[i/字长]， 位号=i mod 字长

## 5、虚拟页式存储地址转换过程

### ①、页式存储管理的地址转换

#### 页表：

记录装入内存的逻辑页面与物理页面的对应关系
是硬件进行地址转换的依据
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581488009727-4abaa272-ddd7-4332-bae8-fcc9704c7f43.png#align=left&display=inline&height=466&margin=%5Bobject%20Object%5D&name=image.png&originHeight=466&originWidth=506&size=20378&status=done&style=none&width=506)

#### 硬件支持：

页表始址寄存器和页表长度寄存器，分别用存储正在运行程序的页表在内存的起始地址和页表的长度。

#### 地址转换过程：

在执行检索前，先将页号与页表长度进行比较，若页号大于或等于页表长度，则地址越界

#### 若未出现越界错误，则将页表始址与页号和页表项长度的乘积相加，则找到该表项在页表中的位置，找到该页的物理页号

将有效地址的页内地址送入物理地址寄存器的块内地址字段中

![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581488556959-243b6c40-a320-494c-9003-38132f06ec68.png#align=left&display=inline&height=308&margin=%5Bobject%20Object%5D&name=image.png&originHeight=308&originWidth=569&size=68635&status=done&style=none&width=569)

#### 十进制计算

物理地址=物理页面号\*块长+页内地址

#### 二进制计算

物理页面好作为绝对地址的高位 地址，页内地址作为它的地址部分。

#### 页表项

物理页面号：页面在内存对应的物理页面号
有效位：页面是在内存还是在外村
访问位：页面是在内存中是否被访问过
修改位：页面在内存中是否被修改过
保护位：页面能否读/写

#### 页表

多级页表
散列页表
反置页表

#### 转换检测缓冲区（TLB）

高速缓存，也称为快表，登记了页表中的部分页号和物理页面的对应关系。

### ②、缺页异常处理

#### 缺页异常

若在页表中发现所要访问的页面不在内存，则产生缺页异常

#### 处理

查看有无空闲页面，若有，把要访问的页面调入内存；若无，选择一页换出内存，再把要访问的页面调入内存。

### ③、页面调度策略

#### 调入策略：

决定什么时候将一个页由外存调入内存。两种方法，请求调页和预调页。

#### 置页策略：

当产生缺页时，将所调入的页面置于何处。

#### 置换策略：

如果内存已满，确定哪个页面从内存中移出，为新的页面腾出空位。三种方法：固定分配局部置换、可变分配全局置换、可变分配局部置换。

### ④、页面置换算法

#### “抖动”或"颠簸"：

刚被换出的页面又立即要用，把它装入内存后，不久又被换出，换出不久又被调入内存，如此反复，使调度非常频繁。

#### 算法：

OPT、FIFO、第二次机会页面置换算法、CLOCK、LRU 算法

#### OPT--理想页面置换算法

由 Belady 于 1966 年提出的一种理论上的算法。
其所选择的被淘汰页面，将是以后永不使用的，或是在最长（未来）时间内不再被访问的页面。
采用 OPT 算法，通常可保证获得最低的缺页率。

# 五、文件系统

## 1、文件系统的任务

### ①、文件的定义

#### 研究文件系统的两种观点：

用户观点：关心文件由什么组成，如何命名，如何保护文件，可以进行任何操作。
系统观点：文件目录是怎样实现的，怎样管理存储空间，文件存储位置，磁盘实际运作方式及，存取速度，磁盘利用率等等。

#### 文件的定义：

一组带标识的、在逻辑上有完整意义的信息项的序列。

#### 读写指针:

读指针用来记录文件当前的读取位置，写指针用来记录文件当前的写入位置。

#### 特点：

存储在磁盘，可长期保存。

### ②、文件系统的定义

文件系统是操作系统中统一管理信息资源的一种软件。它管理文件的存储、检索、更新，提供更安全的共享和保护手段，并方便用户使用。

#### 功能：

统一管理文件的存储空间，实施存储空间的分配与回收
实现文件按名存取，以对用户透明的方式管理名字空间
实现文件信息的共享，并提供文件的共享和保密措施。
向用户提供一个方便使用的接口
系统维护及向用户提供有关信息
保持文件系统的执行效率
提供与 I/O 的统一接口

### ③、文件的存储介质及存取方式

#### 外存储设备的特点

特点：容量大、断电后仍可保存信息
组成：驱动部分和存储介质部分
种类：磁盘、磁带、磁鼓、纸带、光盘、闪存

#### 外存储设备的存储介质

磁带
特点：容量大、存取速度慢、适合顺序存储
磁盘
分类：软盘和硬盘
特点：容量大、成本低、适合随机存储
磁盘的物理地址由柱面号、磁头号、扇区号组成
光盘
是利用在激光的作用下特性发送变化的一些材料制成的非磁性记录介质。
特点：容量大、速度快、价格便宜
闪存
特点：电擦除，随机存取、可靠性高、寿命长

#### 文件在存储设备中的存取方式

顺序存取：
按从前到后的次序依次访问文件的各个信息项
随机存取：
又称直接存取，允许用户按任意的次序、直接存取文件中的任意一个记录，或者根据存取命令把读写指针移到文件中的指定记录处读取。

### ④、文件的分配

#### 按文件的用途分类

系统文件
库函数文件
用户文件

#### 按文件的组织方式分类

普通文件
目录文件
特殊文件

#### 一些常见的文件分类方式

按文件的保护方式：只读文件、读写文件、可执行文件、五保护文件
按信息的流向分：输入文件、输出文件、输入输出文件
按存放时限分：临时文件、永久文件、档案文件
按存储介质分：磁盘文件、磁带文件、卡片文件
按文件的组织结构分类：逻辑文件、物理文件

## 2、文件的逻辑结构和物理结构

> 文件的逻辑结构
> 从用户观点出发所观察到的文件组织形式
> 文件的物理结构
> 又称为文件的存储结构，是指系统将文件存储在外存上所形成的一种存储组织形式，是用户看不见的

### ①、文件的逻辑结构

#### 设计文件逻辑结构的原则：

易于操作
查找快捷
修改方便
空间紧凑

文件的逻辑机构
文件的逻辑结构所描述的信息是文件中信息的组织形式，可分为三类：
流式文件：有序字符的集合，基本单位是字符。源程序、目标代码等属于流式文件
记录式文件： 是一组有序记录的集合，基本单位是记录。又可分为定长记录文件和变长记录文件。

顺序结构
又称连续结构，它把逻辑上连续的文件信息依次存放在连续编号的物理块中。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581575551632-9786910d-978a-48a4-a5f4-de5e97cad43d.png#align=left&display=inline&height=255&margin=%5Bobject%20Object%5D&name=image.png&originHeight=255&originWidth=539&size=9935&status=done&style=none&width=539)

优点：
存取速度快，一旦知道了文件在存储设备上的起始块号和文件长度，便能快速进行存取。
支持顺序存放和随机存取
缺点：
文件不能动态增长
要求为一个文件分配连续的存储空间
不能灵活地删除和插入记录
出现碎片

链接结构
链接结构原理
将逻辑上连续的文件分散存储在若干个不连续的物理块中。
每个物理块中都设有一个指针，指向其后续的物理块。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581576173953-218716ed-aacf-4fca-a292-f66f1a497e9a.png#align=left&display=inline&height=346&margin=%5Bobject%20Object%5D&name=image.png&originHeight=346&originWidth=698&size=16504&status=done&style=none&width=698)

优点
解决了碎片问题，提供了磁盘空间利用率
文件可以动态扩充
缺点
存取速度慢，不适于随机存取
可靠性差

索引结构
索引结构原理
为每个文件分配一个索引块（表），把分配给该文件的所有盘块号，都记录在该索引块中
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581576402661-8c66e4b1-4318-49c2-9018-8f9ee4646d1c.png#align=left&display=inline&height=281&margin=%5Bobject%20Object%5D&name=image.png&originHeight=281&originWidth=653&size=63915&status=done&style=none&width=653)
优点
文件动态增长
不要求为一个文件分配连续的存储空间
能灵活地删除和插入记录
能顺序存取和随机存取
缺点
引起较多的寻道次数和寻道时间
索引表本身增加了存储空间的开销

多级索引
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581576786328-7bdd0bfe-fcd4-46e1-a842-149381035d1f.png#align=left&display=inline&height=307&margin=%5Bobject%20Object%5D&name=image.png&originHeight=307&originWidth=343&size=20227&status=done&style=none&width=343)

## 3、文件目录

### ①、文件控制块

为文件设置的用于描述和控制文件的数据结构。文件管理程序可借助于文件控制块中的信息，对文件施以各种操作。

文件目录
文件控制块的游戏集合（文件于文件控制块一一对应）称为文件目录，一个文件控制块就是一个文件目录项。

文件控制块的内容
基本信息类：文件名、文件物理位置、文件逻辑结构、文件的物理结构。
存取控制信息类：文件主的存取权限、核准用户的存取权限以及一般用户的存取权限。
使用信息类：文件的建立日期和时间、文件上一次修改的日期和时间、当前已打开该文件的进程数、是否被其他进程锁住、文件在内存中是否已被修改但尚未拷贝到盘上等。

②、文件目录和当前目录
一级目录结构
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581817033766-7deb0d04-1681-4c24-9a31-578cfb716c25.png#align=left&display=inline&height=247&margin=%5Bobject%20Object%5D&name=image.png&originHeight=247&originWidth=446&size=12688&status=done&style=none&width=446)
优点：简单且能实现目录管理的基本功能-按名存取
缺点：查询速度慢、不允许重名

二级目录结构
为了改变一级目录文件命名冲突，并提高对目录文件索引速度而将目录分为两级；
一级称为主文件目录，给出用户名，用户子目录所在的物理位置；
二级称为用户文件目录，给出该用户所有文件的 FCB

优点：解决了文件的重名问题和文件共享问题，提高搜索速度，查找时间降低
缺点：不太适合大量用户和大量文件的大系统，增加了系统开销。

多级目录
多级目录结构也称树形目录，产生于 unix 操作系统，已被现代操作系统广泛采用
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581817395366-2fc27302-640f-491d-b83e-bbed152750bb.png#align=left&display=inline&height=436&margin=%5Bobject%20Object%5D&name=image.png&originHeight=436&originWidth=514&size=19376&status=done&style=none&width=514)
优点：层次结构清晰，便于管理和保护；有利于文件分类；解决重名问题；提高文件检索速度；能进行存取权限的控制。
缺点：查找一个文件按路径名逐层检查，由于每个文件都存放在外村，多次访盘影响速度

当前目录与目录检索
当前目录：当前正在使用的目录（也称工作目录或值班目录）
目录检索：用户访问文件时，需要进行目录检索，这时用户给出文件名，系统按名寻找目录项。
检索方法：全路径名（绝对路径名），相对路径

③、目录项和目录文件
目录项
一个文件控制块做成一个定长记录，这个记录称为目录项
目录文件
多个文件的文件控制块集中在一起组成了文件的目录。
文件目录以文件的形式保存，该文件称为目录文件。

④、目录项分解法
目的：
加快目录检索速度
分解：
目录项分解称两部分：符号目录项（次部）和基本目录下（主部）。
符号目录项：包含文件名和文件号
基本目录项：除文件名以外的 FCB 的其他全部信息。
优点：
减少磁盘的访问次数，提高文件目录检索速度
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581817993589-1af31203-eb23-42f6-b091-4d6725a659df.png#align=left&display=inline&height=300&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=429&size=15104&status=done&style=none&width=429)

⑤、UNIX 的文件目录结构
i 结点的引入
文件目录通常是存放在磁盘上的，可能要占用大量的盘块。在查找目录的过程中，需要多次启动磁盘。
UNIX 系统，采用了把文件名与文件描述信息分开的方法，亦即，使文件描述信息单独形成一个称为索引结点的数据结构，简称为 i 结点

i 结点的内容
文件主标识符、文件类型、文件存取权限、文件物理地址、文件长度、文件连接计数、文件存取时间等
物理结构
三级索引结构
目录查询

⑥、FAT 文件系统的实现
FAT 的含义：
文件分配表--File Allocation Table，最初为 DOS 系统设计，适合小容量磁盘，分配给文件的所有盘块号都放在该表中。
三个版本：
FAT-12、FAT-16、FAT-32

## 4、文件存储空间

①、磁盘空间管理
基本思想
对于磁盘空空感觉的分配和回收方法。

②、磁盘空间的分配与回收算法
位示图
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581818652092-9d77546c-de59-41d3-99d5-98045582b919.png#align=left&display=inline&height=209&margin=%5Bobject%20Object%5D&name=image.png&originHeight=209&originWidth=480&size=12219&status=done&style=none&width=480)

空闲块表
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581818698228-3069ab7f-7a78-4922-9631-78744541f43a.png#align=left&display=inline&height=160&margin=%5Bobject%20Object%5D&name=image.png&originHeight=160&originWidth=273&size=3979&status=done&style=none&width=273)

空闲块链
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581819155008-db0eb4cd-74ac-4f17-8e1c-a1cbf1f3cd49.png#align=left&display=inline&height=248&margin=%5Bobject%20Object%5D&name=image.png&originHeight=248&originWidth=1106&size=610468&status=done&style=none&width=1106)

③、成组链接的含义
文件区中的所有空闲盘块，被分成若干个组，比如，将每 100 个盘块作为一组。
将每一组含有的盘块总数 N 和该组所有的盘块号，记入其前一组的第一个盘块中。这样，由各组的第一个盘块可链成一条链。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581819142631-8d2c6846-71b5-4294-9fa0-675a21da786f.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&name=image.png&originHeight=477&originWidth=815&size=281473&status=done&style=none&width=815)
分配：
在空闲块链中，不足 100 块的组，通常放在内存专用块中，系统初始化时，先把专用块内容读取到内存中，需要分配时，就直接在内存中找到哪块是空闲的，然后进行分配，空闲块数减 1，如果这一组的第一个空闲块页要分配，在分配之前，先把其保存的下一组的空闲盘块号读入内存中，再分配出去，依次类推。

回收：
归还一个空闲盘块时，把要归还的块号登记在当前组中，空闲块数加 1，如果当前已满 100 块，则把这 100 组中，空闲块数加 1，如果当前组已满 100 块，则把这 100 个块号写到要归还的那块中，该块就称为新组的第一块。

优点:
分配和回收空闲块时均在内存中查找和修改，只有在一组空闲块分配完成或空闲的磁盘块构成一组时才需要启动磁盘读写，效率高，能快速找到大量空闲盘块的地址，UNIX 采取这种方案

## 5、实现文件系统的表目

### ①、系统打开文件表

专门用来保存已打开文件的文件控制块
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581819739452-7a849b7d-ff34-4b9f-a8fa-50a89aa8bd5c.png#align=left&display=inline&height=116&margin=%5Bobject%20Object%5D&name=image.png&originHeight=116&originWidth=510&size=7865&status=done&style=none&width=510)
共享计数：记录有多少个进程同时打开该文件
修改标志：指文件控制块或 i 结点的内容是否被修改过，如果修改过，则关闭文件时要将文件控制块写回磁盘

### ②、用户打开文件表

每个用户都有一个“用户打开文件表”，其位置记录在 PCB 中，以 UNIX 为例，内容如下：
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581819895178-73b56d48-11a4-4336-9fc5-e55527bb1455.png#align=left&display=inline&height=118&margin=%5Bobject%20Object%5D&name=image.png&originHeight=118&originWidth=502&size=7864&status=done&style=none&width=502)

6、文件及目录的操作
①、典型的文件操作
建立文件
打开文件
读文件
写文件
关闭文件
删除文件

②、典型的目录操作
以 UNIX 系统为例
创建目录 creat
打开目录 open
读目录 readdir
创建链接 link
删除链接 ulink
修改目录名 rename
关闭目录 closedir
删除目录 delete

7、文件系统的性能
①、磁盘高速缓存
基本思想：
系统在内存中保存一些磁盘块，这些磁盘块在逻辑上属于磁盘，内存的这一区域被称为块高速缓存。
运行时，系统检查所有的读请求，查看文件块是否在高速缓存，在，则读；不在，首先启动磁盘，将所需块读到高速缓存，再复制到其他内存区域。若高速缓存已满，按照淘汰算法，选择较少使用的磁盘块换出。
块高速缓存要定期写回磁盘，以保存对磁盘块的修改。

文件系统一致性问题：
如果在修改过的磁盘块写回磁盘之前，系统出现故障，则文件系统有可能回处于不一致状态。特别是一些未写回的块是 i 结点、目录块或包含空闲表的磁盘块时，问题尤为严重。这一问题称为文件系统一致性问题。
高速缓冲的典型应用：记录的成组

记录的成组
把若干个逻辑记录合成一组存储到一个物理块的工作，称为记录的成组。
每块中的逻辑记录个数称为快因子
实现原理：信息交换以块为单位，故成组需要使用内存缓冲区来完成。缓冲区的长度=记录的长度\*块因子
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581820936990-184b0657-55a6-4fb1-b721-3dcaba68a5d3.png#align=left&display=inline&height=234&margin=%5Bobject%20Object%5D&name=image.png&originHeight=234&originWidth=754&size=12472&status=done&style=none&width=754)

记录的分解

> 从一组记录中把一个逻辑记录分离出来的过程称为记录的分解。

过程：当用户请求读某记录时，文件系统首先找到该记录所在的磁盘块的位置，然后把含有该记录的物理块全部读入内存缓冲区，从内存缓冲区分解出指定的记录，然后送到用户工作区。
![image.png](https://cdn.nlark.com/yuque/0/2020/png/290620/1581821093136-12fb2edb-4535-42c1-b04c-ea6fd8c077c9.png#align=left&display=inline&height=304&margin=%5Bobject%20Object%5D&name=image.png&originHeight=304&originWidth=684&size=14425&status=done&style=none&width=684)

成组优点：提高了磁盘利用率，减少了启动盘的次数，提高了系统工作效率
要考虑的效率：定长记录和不定长记录

2、RAID 技术（磁盘阵列技术）
RAID （ Redundant Array of Independent Disks ）即独立磁盘冗余阵列，通常简称为磁盘阵列。
简单地说， RAID 是由多个独立的高性能磁盘驱动器组成的磁盘子系统，从而提供比单个磁盘更高的存储性能和数据冗余的技术。 RAID 是一类多磁盘管理技术，其向主机环境提供了成本适中、数据可靠性高的高性能存储

好处主要有以下三种：
通过把多个磁盘组织在一起作为一个逻辑卷提供磁盘跨越功能。
通过把数据分成多个数据块（Block）并行写入/读出多个磁盘以提高访问磁盘的速度
通过镜像或校验操作提供容错能力

RAID 不断地发展和革新，在计算机存储领域得到了广泛的应用，从高端系统逐渐延伸到普通的中低端系统。 RAID 技术如此流行，源于其具有显著的特征和优势，基本可以满足大部分的数据存储需求。

6、文件共享保护与保密
①、文件共享
文件共享的概念
文件共享是指一个文件可以允许多个用户共同使用。
文件共享的分类
从共享时间段上看，共享文件有两种使用情况：
文件可以同时使用
文件不允许同时使用
三种共享方式
文件被多个用户使用，由存取权限抗旨
文件被多个用户使用，但分别用自己的读写指针
文件被多个用户使用，但共享读写指针

# 六、设备管理
